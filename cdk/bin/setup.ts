// This script examines stack outputs and writes .env.local file
// eslint-disable-next-line import/named
import { CloudFormationClient, DescribeStacksCommand, DescribeStacksCommandOutput } from '@aws-sdk/client-cloudformation';
import * as fs from 'fs';
import Config from '../lib/config';

const euWestCFClient = new CloudFormationClient({ region: 'eu-west-1' });

type BackendStackOutputs = {
  AppSyncAPIURL: string;
  AppSyncAPIKey: string;
  LoadBalancerDnsName: string;
};

type FrontendStackOutputs = {
  CloudFrontDomainName: string;
};

async function readStackOutputsForRawStackName(stackName: string): Promise<Record<string, string>> {
  const output: DescribeStacksCommandOutput = await euWestCFClient.send(new DescribeStacksCommand({ StackName: stackName }));
  return (
    output.Stacks?.[0].Outputs?.reduce((params, param) => {
      // Include only non-null values. Exclude automatically generated outputs by CDK
      if (param.OutputKey && param.OutputValue && !param.OutputKey.startsWith('ExportsOutput')) {
        params[param.OutputKey] = param.OutputValue;
      }
      return params;
    }, {} as Record<string, string>) || {}
  );
}

async function readBackendStackOutputs(): Promise<BackendStackOutputs> {
  return (await readStackOutputsForRawStackName('DvkBackendStack-' + Config.getEnvironment())) as BackendStackOutputs;
}

async function readFrontendStackOutputs(): Promise<FrontendStackOutputs> {
  return (await readStackOutputsForRawStackName('SquatSiteStack-' + Config.getEnvironment())) as FrontendStackOutputs;
}

function writeEnvFile(fileName: string, variables: { [p: string]: string }) {
  let envFile = '# This file is automatically generated\n';
  for (const key in variables) {
    // eslint-disable-next-line no-prototype-builtins
    if (variables.hasOwnProperty(key) && variables[key]) {
      envFile += `${key}=${variables[key]}\n`;
    }
  }
  fs.writeFileSync(fileName, envFile);
}

async function main() {
  const backendStackOutputs = await readBackendStackOutputs();
  const frontendStackOutputs = await readFrontendStackOutputs();
  writeEnvFile('../.env.local', {
    REACT_APP_API_URL: backendStackOutputs.AppSyncAPIURL,
    REACT_APP_API_KEY: backendStackOutputs.AppSyncAPIKey,
    REACT_APP_REST_API_URL: `http://${backendStackOutputs.LoadBalancerDnsName}/api`,
    REACT_APP_FRONTEND_DOMAIN_NAME: frontendStackOutputs.CloudFrontDomainName,
  });
}

main().catch((e) => {
  console.log(e);
  process.exit(1);
});
