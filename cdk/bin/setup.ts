// This script examines stack outputs and writes .env.local file
// eslint-disable-next-line import/named
import { CloudFormationClient, DescribeStacksCommand, DescribeStacksCommandOutput } from '@aws-sdk/client-cloudformation';
// eslint-disable-next-line import/named
import { GetSecretValueCommand, ListSecretsCommand, ListSecretsCommandOutput, SecretsManagerClient } from '@aws-sdk/client-secrets-manager';
import * as fs from 'fs';
import Config from '../lib/config';
import { readParametersByPath } from '../lib/lambda/environment';

const euWestCFClient = new CloudFormationClient({ region: 'eu-west-1' });
const euWestSecretClient = new SecretsManagerClient({ region: 'eu-west-1' });

type BackendStackOutputs = {
  AppSyncAPIURL: string;
  AppSyncAPIKey: string;
  LoadBalancerDnsName: string;
};

type FrontendStackOutputs = {
  CloudFrontDomainName?: string;
};

async function readStackOutputsForRawStackName(stackName: string): Promise<Record<string, string>> {
  const output: DescribeStacksCommandOutput = await euWestCFClient.send(new DescribeStacksCommand({ StackName: stackName }));
  return (
    output.Stacks?.[0].Outputs?.reduce((params, param) => {
      // Include only non-null values. Exclude automatically generated outputs by CDK
      if (param.OutputKey && param.OutputValue && !param.OutputKey.startsWith('ExportsOutput')) {
        params[param.OutputKey] = param.OutputValue;
      }
      return params;
    }, {} as Record<string, string>) || {}
  );
}

async function readBackendStackOutputs(): Promise<BackendStackOutputs> {
  return (await readStackOutputsForRawStackName('DvkBackendStack-' + Config.getEnvironment())) as BackendStackOutputs;
}

async function readFrontendStackOutputs(): Promise<FrontendStackOutputs> {
  try {
    return (await readStackOutputsForRawStackName('SquatSiteStack-' + Config.getEnvironment())) as FrontendStackOutputs;
  } catch (e) {
    // Frontend stack is not mandatory for local development
    return { CloudFrontDomainName: undefined };
  }
}

async function readSecrets(path: string, global = false): Promise<Record<string, string>> {
  const variables: Record<string, string> = {};
  let nextToken;
  do {
    const filters = [{ Key: 'name', Values: [(global ? '!' : '') + path] }];
    const output: ListSecretsCommandOutput = await euWestSecretClient.send(new ListSecretsCommand({ Filters: filters, NextToken: nextToken }));
    for (const param of output.SecretList || []) {
      const value = await euWestSecretClient.send(new GetSecretValueCommand({ SecretId: param.ARN }));
      if (param.Name && value.SecretString) {
        variables[global ? param.Name : param.Name.replace(path, '')] = value.SecretString;
      }
    }
    nextToken = output.NextToken;
  } while (nextToken);
  return variables;
}

async function readParametersForEnv(environment: string): Promise<Record<string, string>> {
  if (!Config.isFeatureEnvironment()) {
    const results: Record<string, string> = {
      ...(await readParametersByPath('/')), // Read global parameters from root
      ...(await readParametersByPath('/' + environment + '/')), // Then override with environment specific ones if provided
      ...(await readSecrets(environment + '/', true)),
      ...(await readSecrets(environment + '/')),
    };
    return results;
  }
  // feature pipeline has environment variables already in place
  return {};
}

function writeEnvFile(fileName: string, variables: { [p: string]: string }) {
  let envFile = '# This file is automatically generated\n';
  for (const key in variables) {
    // eslint-disable-next-line no-prototype-builtins
    if (variables.hasOwnProperty(key) && variables[key]) {
      envFile += `${key}=${variables[key]}\n`;
    }
  }
  fs.writeFileSync(fileName, envFile);
}

async function main() {
  const backendStackOutputs = await readBackendStackOutputs();
  const frontendStackOutputs = await readFrontendStackOutputs();
  const envParameters = await readParametersForEnv(Config.getEnvironment());
  writeEnvFile('../.env.local', {
    REACT_APP_API_URL: backendStackOutputs.AppSyncAPIURL,
    REACT_APP_API_KEY: backendStackOutputs.AppSyncAPIKey,
    REACT_APP_REST_API_URL: `http://${Config.isDeveloperEnvironment() ? 'localhost:8080' : backendStackOutputs.LoadBalancerDnsName}/api`,
    REACT_APP_FRONTEND_DOMAIN_NAME: frontendStackOutputs.CloudFrontDomainName || 'install frontend stack please',
    REACT_APP_BG_MAP_API_URL: frontendStackOutputs.CloudFrontDomainName ? frontendStackOutputs.CloudFrontDomainName : envParameters.BGMapApiUrl,
    REACT_APP_BG_MAP_API_KEY: envParameters.BGMapApiKey,
  });
}

main().catch((e) => {
  console.log(e);
  process.exit(1);
});
